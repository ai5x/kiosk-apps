#!/bin/bash
# Openbox Autostart - Portrait Mode (90° clockwise rotation)

LOG_FILE="/tmp/openbox-autostart.log"
echo "$(date): Starting openbox autostart (portrait mode)" > "$LOG_FILE"

# Load kiosk configuration
if [ -f "/opt/kiosk/.env" ]; then
    source "/opt/kiosk/.env"
    echo "$(date): Loaded kiosk configuration" >> "$LOG_FILE"
fi

# Apply display configuration (handles any HDMI output)
if [ -x "/opt/kiosk-apps/scripts/apply-display-config.sh" ]; then
    echo "$(date): Running display config script" >> "$LOG_FILE"
    /opt/kiosk-apps/scripts/apply-display-config.sh 2>> "$LOG_FILE"
else
    # Fallback to direct xrandr if script not available
    echo "$(date): Using fallback xrandr method" >> "$LOG_FILE"
    HDMI_OUTPUT=$(xrandr | grep -E "^(HDMI|HDMI-A|HDMI-1)" | grep " connected" | awk '{print $1}' | head -1)
    if [ -n "$HDMI_OUTPUT" ]; then
        /usr/bin/xrandr --output "$HDMI_OUTPUT" --rotate right 2>> "$LOG_FILE"
    fi
fi
echo "$(date): Display configuration completed" >> "$LOG_FILE"

# Wait for X and input devices to fully initialize
sleep 3

# Rotate touchscreen input to match display rotation (90° clockwise)
# Check if touchscreen transformation is enabled
ENABLE_TOUCHSCREEN_TRANSFORM="${ENABLE_TOUCHSCREEN_TRANSFORM:-true}"
if [ "$ENABLE_TOUCHSCREEN_TRANSFORM" = "true" ]; then
    echo "$(date): Looking for touch devices (max 3 attempts)" >> "$LOG_FILE"
    MAX_ATTEMPTS=3
    ATTEMPT=1
    while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
        DEVICES=$(/usr/bin/xinput list 2>/dev/null | grep -i "touch" | grep -o "id=[0-9]*" | cut -d= -f2 || true)
        if [ -n "$DEVICES" ]; then
            echo "$(date): Found touch devices on attempt $ATTEMPT" >> "$LOG_FILE"
            for device in $DEVICES; do
                echo "$(date): Setting transformation for device $device" >> "$LOG_FILE"
                /usr/bin/xinput set-prop $device 'Coordinate Transformation Matrix' 0 1 0 -1 0 1 0 0 1 2>> "$LOG_FILE"
            done
            break
        else
            echo "$(date): No touch devices found, attempt $ATTEMPT/$MAX_ATTEMPTS" >> "$LOG_FILE"
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                sleep 1
            fi
            ATTEMPT=$((ATTEMPT + 1))
        fi
    done
    echo "$(date): Touch configuration completed" >> "$LOG_FILE"
else
    echo "$(date): Touchscreen transformation disabled, skipping" >> "$LOG_FILE"
fi

# Disable screen blanking and power management
xset s off
xset -dpms
xset s noblank

# Hide mouse cursor after inactivity
unclutter -idle 0.1 -root &

# Start kiosk application
/opt/kiosk/start-kiosk.sh &
